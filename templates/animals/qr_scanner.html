{% extends 'base/base.html' %}

{% block title %}QR Code Scanner - Shelter Registry{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header">
                    <h3 class="mb-0">üîç QR Code Scanner</h3>
                    <p class="mb-0 text-muted">Scan QR codes on animal cages for instant access</p>
                </div>
                <div class="card-body">
                    <!-- Scanner Status -->
                    <div id="scanner-status" class="alert alert-info">
                        <div class="d-flex align-items-center">
                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                            <span>Initializing camera...</span>
                        </div>
                    </div>
                    
                    <!-- Camera Preview -->
                    <div id="scanner-container" class="text-center mb-4" style="display: none;">
                        <div id="qr-reader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
                        <div class="mt-3">
                            <button id="start-scan" class="btn btn-success me-2" style="display: none;">
                                üì∑ Start Scanning
                            </button>
                            <button id="stop-scan" class="btn btn-danger me-2" style="display: none;">
                                ‚èπÔ∏è Stop Scanning
                            </button>
                            <button id="switch-camera" class="btn btn-secondary" style="display: none;">
                                üîÑ Switch Camera
                            </button>
                        </div>
                    </div>
                    
                    <!-- Manual Input Alternative -->
                    <div class="card bg-light">
                        <div class="card-body">
                            <h5>Manual Chip ID Lookup</h5>
                            <div class="input-group">
                                <input type="text" id="manual-chip-id" class="form-control" 
                                       placeholder="Enter 15-digit chip ID" maxlength="15" pattern="[0-9]{15}">
                                <button id="manual-lookup" class="btn btn-primary">
                                    üîç Look Up
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Results -->
            <div id="scan-results" style="display: none;">
                <div class="card mt-4">
                    <div class="card-header">
                        <h4 class="mb-0">üìã Animal Information</h4>
                    </div>
                    <div class="card-body" id="animal-info">
                        <!-- Animal data will be populated here -->
                    </div>
                </div>
            </div>
            
            <!-- Error Display -->
            <div id="error-display" class="alert alert-danger mt-4" style="display: none;">
                <h5>‚ùå Error</h5>
                <p id="error-message"></p>
            </div>
        </div>
    </div>
</div>

<!-- QR Scanner JavaScript Library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
let html5QrCode;
let isScanning = false;
let cameras = [];
let currentCameraIndex = 0;

// CSRF Token
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Initialize scanner when page loads
document.addEventListener('DOMContentLoaded', function() {
    initializeScanner();
    setupEventListeners();
});

async function initializeScanner() {
    try {
        // Get available cameras
        cameras = await Html5Qrcode.getCameras();
        
        if (cameras && cameras.length) {
            updateStatus('Camera found! Ready to scan.', 'success');
            showScannerInterface();
            
            // Initialize QR Code scanner
            html5QrCode = new Html5Qrcode("qr-reader");
            
            // Auto-start scanning
            startScanning();
        } else {
            updateStatus('No cameras found. Please use manual input.', 'warning');
        }
    } catch (err) {
        console.error('Error initializing scanner:', err);
        updateStatus('Camera access denied. Please use manual input.', 'danger');
    }
}

function showScannerInterface() {
    document.getElementById('scanner-container').style.display = 'block';
    document.getElementById('start-scan').style.display = 'inline-block';
    document.getElementById('stop-scan').style.display = 'none';
    
    if (cameras.length > 1) {
        document.getElementById('switch-camera').style.display = 'inline-block';
    }
}

async function startScanning() {
    if (isScanning) return;
    
    try {
        const cameraId = cameras[currentCameraIndex].id;
        
        await html5QrCode.start(
            cameraId,
            {
                fps: 10,
                qrbox: { width: 250, height: 250 }
            },
            onScanSuccess,
            onScanFailure
        );
        
        isScanning = true;
        document.getElementById('start-scan').style.display = 'none';
        document.getElementById('stop-scan').style.display = 'inline-block';
        updateStatus('Scanning... Point camera at QR code', 'primary');
        
    } catch (err) {
        console.error('Error starting scan:', err);
        updateStatus('Failed to start camera. Please try manual input.', 'danger');
    }
}

async function stopScanning() {
    if (!isScanning) return;
    
    try {
        await html5QrCode.stop();
        isScanning = false;
        document.getElementById('start-scan').style.display = 'inline-block';
        document.getElementById('stop-scan').style.display = 'none';
        updateStatus('Scanning stopped.', 'secondary');
    } catch (err) {
        console.error('Error stopping scan:', err);
    }
}

function switchCamera() {
    if (cameras.length <= 1) return;
    
    stopScanning().then(() => {
        currentCameraIndex = (currentCameraIndex + 1) % cameras.length;
        setTimeout(startScanning, 500);
    });
}

function onScanSuccess(decodedText, decodedResult) {
    console.log('QR Code scanned:', decodedText);
    
    // Stop scanning to prevent multiple scans
    stopScanning();
    
    // Process the scanned data
    processQRData(decodedText);
}

function onScanFailure(error) {
    // Silent fail - QR scanning failures are common and expected
}

async function processQRData(qrData) {
    updateStatus('Processing QR code...', 'info');
    hideError();
    
    try {
        const response = await fetch('/api/v1/qr/scan/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ qr_data: qrData })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayAnimalInfo(data.animal, data);
            updateStatus('Animal found!', 'success');
        } else {
            showError(data.error || 'Failed to find animal');
            updateStatus('Ready to scan next QR code', 'primary');
            setTimeout(startScanning, 2000);
        }
        
    } catch (error) {
        console.error('Error processing QR data:', error);
        showError('Failed to process QR code. Please try again.');
        updateStatus('Ready to scan next QR code', 'primary');
        setTimeout(startScanning, 2000);
    }
}

async function manualLookup() {
    const chipId = document.getElementById('manual-chip-id').value.trim();
    
    if (!chipId) {
        showError('Please enter a chip ID');
        return;
    }
    
    if (!/^\d{15}$/.test(chipId)) {
        showError('Chip ID must be exactly 15 digits');
        return;
    }
    
    updateStatus('Looking up animal...', 'info');
    hideError();
    
    try {
        const response = await fetch(`/api/v1/animals/by_chip/?chip_id=${chipId}`, {
            headers: {
                'X-CSRFToken': csrfToken,
            }
        });
        
        const data = await response.json();
        
        if (response.ok) {
            displayAnimalInfo(data);
            updateStatus('Animal found!', 'success');
        } else {
            showError(data.error || 'Animal not found');
            updateStatus('Ready for next lookup', 'primary');
        }
        
    } catch (error) {
        console.error('Error in manual lookup:', error);
        showError('Failed to look up animal. Please try again.');
        updateStatus('Ready for next lookup', 'primary');
    }
}

function displayAnimalInfo(animal, scanData = null) {
    const resultsDiv = document.getElementById('scan-results');
    const animalInfoDiv = document.getElementById('animal-info');
    
    const primaryPhoto = animal.primary_photo ? 
        `<img src="${animal.primary_photo.image}" class="img-fluid rounded mb-3" style="max-height: 200px;">` : 
        '<div class="alert alert-light mb-3">üì∑ No photo available</div>';
    
    const qrInfo = scanData ? `
        <div class="alert alert-info mb-3">
            <h6>üì± QR Scan Info</h6>
            <small>
                Scan Type: ${scanData.scan_type || 'unknown'}<br>
                ${scanData.qr_data_current !== undefined ? 
                    `QR Data Current: ${scanData.qr_data_current ? '‚úÖ Yes' : '‚ö†Ô∏è Outdated'}` : ''}
            </small>
        </div>
    ` : '';
    
    animalInfoDiv.innerHTML = `
        <div class="row">
            <div class="col-md-4 text-center">
                ${primaryPhoto}
            </div>
            <div class="col-md-8">
                <h3>${animal.name} üêæ</h3>
                <div class="row mb-3">
                    <div class="col-sm-6">
                        <strong>Chip ID:</strong> ${animal.chip_id}<br>
                        <strong>Species:</strong> ${animal.species_display}<br>
                        <strong>Gender:</strong> ${animal.gender_display}<br>
                        <strong>Age:</strong> ${animal.age_display}
                    </div>
                    <div class="col-sm-6">
                        <strong>Cage:</strong> #${animal.cage_number}<br>
                        <strong>Behavior:</strong> ${animal.behavior_display}<br>
                        <strong>Status:</strong> 
                        <span class="badge bg-${animal.adoption_status === 'available' ? 'success' : 
                                               animal.adoption_status === 'pending' ? 'warning' : 
                                               animal.adoption_status === 'adopted' ? 'primary' : 'secondary'}">
                            ${animal.adoption_status_display}
                        </span>
                    </div>
                </div>
                
                ${qrInfo}
                
                <div class="d-flex gap-2 flex-wrap">
                    <a href="/animal/${animal.id}/" class="btn btn-primary">
                        üìã View Full Record
                    </a>
                    <a href="/animal/${animal.id}/edit/" class="btn btn-outline-primary">
                        ‚úèÔ∏è Edit Animal
                    </a>
                    <button onclick="scanAnother()" class="btn btn-success">
                        üì∑ Scan Another
                    </button>
                </div>
            </div>
        </div>
    `;
    
    resultsDiv.style.display = 'block';
}

function scanAnother() {
    document.getElementById('scan-results').style.display = 'none';
    document.getElementById('manual-chip-id').value = '';
    hideError();
    
    if (cameras.length > 0) {
        startScanning();
    } else {
        updateStatus('Ready for manual input', 'primary');
    }
}

function setupEventListeners() {
    document.getElementById('start-scan').addEventListener('click', startScanning);
    document.getElementById('stop-scan').addEventListener('click', stopScanning);
    document.getElementById('switch-camera').addEventListener('click', switchCamera);
    document.getElementById('manual-lookup').addEventListener('click', manualLookup);
    
    // Enter key for manual input
    document.getElementById('manual-chip-id').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            manualLookup();
        }
    });
    
    // Auto-format chip ID input
    document.getElementById('manual-chip-id').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
    });
}

function updateStatus(message, type = 'info') {
    const statusDiv = document.getElementById('scanner-status');
    statusDiv.className = `alert alert-${type}`;
    statusDiv.innerHTML = `
        <div class="d-flex align-items-center">
            <span>${message}</span>
        </div>
    `;
}

function showError(message) {
    const errorDiv = document.getElementById('error-display');
    const errorMessage = document.getElementById('error-message');
    errorMessage.textContent = message;
    errorDiv.style.display = 'block';
}

function hideError() {
    document.getElementById('error-display').style.display = 'none';
}

// Cleanup on page unload
window.addEventListener('beforeunload', function() {
    if (isScanning && html5QrCode) {
        html5QrCode.stop();
    }
});
</script>
{% endblock %}